{% load static %}
{% load glow_tags cache meta %}

<!DOCTYPE html>
<html lang="ru">
<head {% meta_namespaces_schemaorg %}>
    {% include "meta/meta.html" %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link type="text/css" href="{% static 'main/css/app.css' %}" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="{% static 'images/favicon-96x96.png' %}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}" />
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/apple-touch-icon.png' %}" />
    <meta name="apple-mobile-web-app-title" content="MyWebSite" />
    <link rel="manifest" href="{% static 'images/site.webmanifest' %}" />
    {% block head %}{% endblock %}
    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É —Å—Ä–∞–∑—É, –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ JS
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark-mode');
            document.documentElement.setAttribute('data-bs-theme', 'dark');
        }
    </script>
</head>
<body class="{% block body_class %}{% endblock %}">
<header class="site-header">
    <div class="pg-container header-inner">
        <button id="burger" class="header__burger-menu">
            <span></span><span></span><span></span>
        </button>
        <a class="brand" href="{% url 'home' %}">PageGlow</a>
        <nav class="top-nav" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
            <ul class="menu-list">
                {% show_categories %}
            </ul>
        </nav>

        <div class="user-area">
            <button id="theme-toggle" class="theme-toggle" aria-pressed="false">
                ‚òÄÔ∏è
            </button>
            <a id="search" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0,0,256,256">
                    <g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(10.66667,10.66667)"><path d="M22,20l-2,2l-6,-6v-2h2z"></path><path d="M9,16c-3.9,0 -7,-3.1 -7,-7c0,-3.9 3.1,-7 7,-7c3.9,0 7,3.1 7,7c0,3.9 -3.1,7 -7,7zM9,4c-2.8,0 -5,2.2 -5,5c0,2.8 2.2,5 5,5c2.8,0 5,-2.2 5,-5c0,-2.8 -2.2,-5 -5,-5z"></path><path transform="translate(-5.90254,14.24719) rotate(-44.992)" d="M13.7,12.5h1v3.5h-1z"></path></g></g>
                </svg>
            </a>
            {% if user.is_authenticated %}
                <div class="notific-cont">
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    <div class="notification-bell" id="notification-bell">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#ffffff" viewBox="0 0 24 24">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
                        </svg>
                        <span class="notification-badge" id="notification-badge" style="display:none;">0</span>
                    </div>
                    <div class="notification-dropdown" id="notification-dropdown" style="display:none;">
                        <div class="notification-header">
                            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                            <button id="mark-all-read" class="btn btn-sm btn-link">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
                        </div>
                        <div class="notification-list" id="notification-list"></div>
                    </div>
                </div>
                {% include 'main/includes/user_menu.html' %}
            {% else %}
                <a class="login-pill" href="{% url 'users:login' %}">–í–æ–π—Ç–∏</a>
            {% endif %}
        </div>
    </div>
</header>

<main class="page">
    <div class="pg-container layout">
        <div class="content">
            <div class="search-form">
                <form action="{% url 'search' %}" method="get">
                    <input type="search" placeholder="–ü–æ–∏—Å–∫..." name="q" class="form-control" required="">
                    <button type="submit" class="btn btn-submit"><span class="fa fa-search" aria-hidden="true"></span></button>
                </form>
            </div>
            {% block content %}{% endblock %}
        </div>
        {% cache 604800 side_cache %}
            <aside class="sidebar" aria-label="–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å">
                {% block sidebar %}
                    <aside>
                        {% block sidebar_content %}
                            {% include 'main/includes/sidebar_new_posts.html' %}
                        {% endblock %}
                    </aside>
                {% endblock %}
                {% show_all_tags %}
            </aside>
        {% endcache %}
    </div>

    <div class="pg-container">
        {% block navigation %}{% endblock %}
    </div>
</main>
<footer class="site-footer">
  <div class="pg-container footer-container">
    <div class="footer-logo">
      <h3>PageGlow</h3>
    </div>


    <nav class="footer-nav">
        <p>–°—Å—ã–ª–∫–∏</p>
      <ul>
        {% for m in mainmenu %}
           <li><a href="{% url m.url_name %}">{{ m.title }}</a></li>
        {% endfor %}
      </ul>
    </nav>

    <div class="footer-contacts">
      <p>Email: <a href="mailto:info@pageglow.com">pageglow3@gmail.com</a></p>
      <!-- <p>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:+74951234567">+7‚ÄØ(495)‚ÄØ123‚Äë45‚Äë67</a></p> -->
    </div>

    <div class="footer-social">
      <a href="https://t.me/pageglow">Telegram</a>
      <a href="https://vk.com/pageglow">VK</a>
      <a href="https://github.com/guseintarss/PageGlow3.0/tree/master">GitHub</a>
    </div>
  </div>
    <hr>
    <div class="footer-copyright">
      <p>&copy; 2026 PageGlow. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
</footer>
{% block extra_js %}{% endblock %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
  const avatarToggle = document.getElementById('avatar-toggle');
  const dropdownMenu = document.getElementById('user-dropdown');

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∞–≤–∞—Ç–∞—Ä
  avatarToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    dropdownMenu.style.display =
      dropdownMenu.style.display === 'none' ? 'block' : 'none';
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
  document.addEventListener('click', function(e) {
    if (!avatarToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = 'none';
    }
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      dropdownMenu.style.display = 'none';
    }
  });
});

</script>
<script>
  document.body.addEventListener('htmx:configRequest', function (event) {
    event.detail.headers['X-CSRFToken'] = document.querySelector('meta[name="csrf-token"]').content;
});

</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const toggleButton = document.getElementById('theme-toggle');
    const body = document.body;
    const htmlElement = document.documentElement;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ–º—ã
    function setTheme(isDark) {
        if (isDark) {
            body.classList.add('dark-mode');
            htmlElement.setAttribute('data-bs-theme', 'dark');
            if (toggleButton) {
                toggleButton.setAttribute('data-bs-theme', 'dark');
                toggleButton.textContent = 'üåô';
            }
            localStorage.setItem('theme', 'dark');
        } else {
            body.classList.remove('dark-mode');
            htmlElement.removeAttribute('data-bs-theme');
            if (toggleButton) {
                toggleButton.removeAttribute('data-bs-theme');
            }
            localStorage.removeItem('theme');
        }
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –î–û —Ç–æ–≥–æ, –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–∏–º–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const savedTheme = localStorage.getItem('theme') === 'dark';
    setTheme(savedTheme);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
    if (toggleButton) {
        toggleButton.addEventListener('click', () => {
            const isCurrentlyDark = body.classList.contains('dark-mode');
            toggleButton.textContent = '‚òÄÔ∏è'; 
            setTheme(!isCurrentlyDark);
        });
    }
});

</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const burger = document.getElementById('burger');
  const menu = document.getElementById('menu');
  const siteHeader = document.querySelector('.site-header'); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
  function closeMenu() {
    siteHeader.classList.remove('open');
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –±—É—Ä–≥–µ—Ä ‚Äî toggles –º–µ–Ω—é
  burger.addEventListener('click', () => {
    siteHeader.classList.toggle('open');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –≤—Å–µ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
  document.addEventListener('click', (event) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é –∏–ª–∏ –Ω–∞ –±—É—Ä–≥–µ—Ä–µ
    if (!siteHeader.classList.contains('open')) {
      return; // –ú–µ–Ω—é —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    }

    const isClickInsideMenuOrBurger = 
      siteHeader.contains(event.target) || 
      burger.contains(event.target);

    if (!isClickInsideMenuOrBurger) {
      closeMenu(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω–µ –Ω–µ–≥–æ
    }
  });
});


</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const burger = document.getElementById('search');

    burger.addEventListener('click', () => {
    document.querySelector('.search-form').classList.toggle('open');
    });
});
</script>
{% if user.is_authenticated %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const bell = document.getElementById('notification-bell');
    const dropdown = document.getElementById('notification-dropdown');
    const badge = document.getElementById('notification-badge');
    const list = document.getElementById('notification-list');
    const markAllBtn = document.getElementById('mark-all-read');
    
    function loadNotifications() {
        fetch('{% url "notifications" %}')
            .then(response => response.json())
            .then(data => {
                if (data.unread_count > 0) {
                    badge.textContent = data.unread_count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                list.innerHTML = '';
                if (data.notifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                } else {
                    data.notifications.forEach(n => {
                        const item = document.createElement('div');
                        item.className = 'notification-item' + (n.is_read ? '' : ' unread');
                        item.innerHTML = `
                            <div class="notification-content">
                                <span class="notification-message">${n.message}</span>
                                <span class="notification-time">${n.created_at}</span>
                            </div>
                        `;
                        if (n.post_url) {
                            item.style.cursor = 'pointer';
                            item.onclick = () => window.location.href = n.post_url;
                        }
                        list.appendChild(item);
                    });
                }
            });
    }
    
    bell.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        if (dropdown.style.display === 'block') {
            loadNotifications();
        }
    });
    
    markAllBtn.addEventListener('click', function() {
        fetch('{% url "mark_notifications_read" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(() => {
            badge.style.display = 'none';
            loadNotifications();
        });
    });
    
    document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && !bell.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadNotifications();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadNotifications, 30000);
});
</script>
{% endif %}
</body>
</html>