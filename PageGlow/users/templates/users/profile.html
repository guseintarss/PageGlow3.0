{% extends 'base.html' %}

{% block head %}
<!-- Подключение HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<!-- CSRF-токен -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Обработка CSRF для HTMX -->
<script>
document.body.addEventListener('htmx:configRequest', function (event) {
    event.detail.headers['X-CSRFToken'] = document.querySelector('meta[name="csrf-token"]').content;
});
</script>

{% endblock %}

{% block content %}
<div class="post">

    <div class="user-photo">
        {% if user.photo %}
        <p><img class="user-img-article" src="{{ user.photo.url }}">
        {% else %}
        <p><img class="user-img-article" src="{{ default_image }}">
        {% endif %}
    </div>

    <h1>{{user.username}}</h1>
    <p><span class="span">{{user.last_name}} {{user.first_name}}</span></p>
      
    {%if user.about_me%}
    <p>{{user.about_me}}</p>
    {%endif%}
    <hr>
    <h4>Посты пользователя {{user.username}}</h4>
    <a class="a-link position-absolute bottom-0 mb-1 p-3 end-0" href="{% url 'users:edit_profile' %}">
        <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" >
        <path d="M5 21h14c1.1 0 2-.9 2-2v-7h-2v7H5V5h7V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2"/><path d="M7 13v3c0 .55.45 1 1 1h3c.27 0 .52-.11.71-.29l9-9a.996.996 0 0 0 0-1.41l-3-3a.996.996 0 0 0-1.41 0l-9.01 8.99A1 1 0 0 0 7 13m10-7.59L18.59 7 17.5 8.09 15.91 6.5zm-8 8 5.5-5.5 1.59 1.59-5.5 5.5H9z"/></svg>
    </a>  
</div>

<div class="post">
  <ul class="nav nav-tabs">
          <li class="nav-item">
            <a href="#published" class="nav-link tab" aria-current="page">Опубликованные ({{ published_posts.count }})</a>
          </li>
          <li class="nav-item">
            <a href="#drafts" class="nav-link tab" aria-current="page">Черновики ({{ drafts.count }})</a>
          </li>
          <li class="nav-item">
            <a href="#favorites" class="nav-link tab" aria-current="page">Избранные ({{ favorites.count }})</a>
          </li>
  </ul>
</div>
      <!-- Контент вкладок -->
      <div id="published" class="content-tab">
          {% for post in published_posts %}
              <article class="post">
                  <h3><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></h3>
                  <p class="meta">Категория: {{post.cat.name}} &bull; Дата: {{post.time_update|date:"d.m.Y"}} {{post.author.username|default:'Неизвестно'}}</p>
                      {% if post.photo %}
                        <p><img class="img-article-left thumb" src="{{post.photo.url}}" alt=""></p>
                    {% endif %}
                  {% autoescape off %}
                  <p class="meta">{{ post.meta }}</p>
                  {{ post.content|truncatewords:20|safe }}
                  {% endautoescape %}
                  <p><a class="read-more" href="{% url 'edit_page' post.slug %}">Редактировать пост</a></p>
                  <p><a class="read-more" href="{{ post.get_absolute_url }}">Читать далее→</a></p>
                  <p><a class="delete-post" href="{% url 'users:article-delete' post.slug %}"><svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" >
              <path d="M17 6V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H2v2h2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8h2V6zM9 4h6v2H9zM6 20V8h12v12z"></path><path d="M9 10h2v8H9zm4 0h2v8h-2z"></path>
              </svg></a></p>
              </article>
          {% empty %}
              <p>Нет опубликованных постов.</p>
          {% endfor %}
      </div>

      <div id="drafts" class="content-tab" style="display: none;">
          {% for post in drafts %}
              <article class="post">
                  <h3>{{ post.title }}</h3>
                  <p class="meta">Категория: {{post.cat.name}} &bull; Дата: {{post.time_update|date:"d.m.Y"}} {{post.author.username|default:'Неизвестно'}}</p>
                      {% if post.photo %}
                        <p><img class="img-article-left thumb" src="{{post.photo.url}}" alt=""></p>
                    {% endif %}
                  {% autoescape off %}
                  <p class="meta">{{ post.meta }}</p>
                  {{ post.content|truncatewords:20|safe }}
                  {% endautoescape %}
                  <p><a class="read-more" href="{% url 'edit_page' post.slug %}">Редактировать пост</a></p>
                  <p><a class="delete-post" href="{% url 'users:article-delete' post.slug %}"><svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" >
              <path d="M17 6V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H2v2h2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8h2V6zM9 4h6v2H9zM6 20V8h12v12z"></path><path d="M9 10h2v8H9zm4 0h2v8h-2z"></path>
              </svg></a></p>
              </article>
          {% empty %}
              <p>Нет черновиков.</p>
          {% endfor %}
      </div>

      <div id="favorites" class="content-tab" style="display: none;">
          {% for post in favorites %}
              <article class="post">
                  <h3><a href="{{ post.get_absolute_url }}">{{ post.title }}</a></h3>
                  <p class="meta">Категория: {{post.cat.name}} &bull; Дата: {{post.time_update|date:"d.m.Y"}} {{post.author.username|default:'Неизвестно'}}</p>
                      {% if post.photo %}
                        <p><img class="img-article-left thumb" src="{{post.photo.url}}" alt=""></p>
                    {% endif %}
                  {% autoescape off %}
                  <p class="meta">{{ post.meta }}</p>
                  {{ post.content|truncatewords:20|safe }}
                  {% endautoescape %}
                  <p><a class="read-more" href="{{ post.get_absolute_url }}">Читать далее→</a></p>
              </article>
          {% empty %}
              <p>Нет избранных постов.</p>
          {% endfor %}
      </div>

<!-- 
{% for p in posts %}
<article class="post">

   {% if p.is_published == True %}<p><span class="p-2 mb-2 bg-success text-white">Опубликовано</span></p>{% elif p.is_published == False %}<p><span class="p-2 mb-2 bg-warning text-dark">Черновик</span></p>{% endif %}
    <h2>{{ p.title }}</h2>
    <p class="meta">Категория: {{p.cat.name}} &bull; Дата: {{p.time_update|date:"d.m.Y"}} {{p.author.username|default:'Неизвестно'}}</p>
    {% if p.photo %}
        <p><img class="img-article-left thumb" src="{{p.photo.url}}" alt=""></p>
    {% endif %}
    <div class="post-content">
        {% autoescape off %}
        <p class="meta">{{ p.meta }}</p>
        {{ p.content|truncatewords:20|safe }}
        {% endautoescape %}
    </div>
    <p><a class="read-more" href="{% url 'edit_page' p.slug %}">Редактировать пост</a></p>
    <p><a class="read-more" href="{{ p.get_absolute_url }}">Читать далее→</a></p>
    <p><a class="delete-post" href="{% url 'users:article-delete' p.slug %}"><svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" >
<path d="M17 6V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H2v2h2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8h2V6zM9 4h6v2H9zM6 20V8h12v12z"></path><path d="M9 10h2v8H9zm4 0h2v8h-2z"></path>
</svg></a></p>
</article>
{% empty %}
<p>Постов нет</p>
{% endfor %} -->
{% endblock %}

{% block extra_js %}
<script>
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('href').replace('#', '');
                document.querySelectorAll('.content-tab').forEach(tab => {
                    tab.style.display = tab.id === target ? 'block' : 'none';
                });
            });
        });
    </script>
<script>
    document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault(); // отменяем переход по ссылке
    const filter = this.dataset.filter; // получаем значение data-filter
    loadArticles(filter); // вызываем функцию загрузки статей
    // обновляем активную вкладку
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    this.classList.add('active');
  });
});
</script>
{%endblock%}