{% extends 'base.html' %}

{% block content %}
<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è -->
<div class="reading-progress-bar" id="reading-progress"></div>

<article class="post">
    <div class="post-content">
        <h1>{{ post.title }}</h1>
        <div class="post-meta-header">
            <div class="author-info">
                {% if post.author.photo %}
                <img class="author-avatar" src="{{ post.author.photo.url }}" alt="{{ post.author.username }}">
                {% else %}
                <img class="author-avatar" src="{{ default_image }}" alt="{{ post.author.username }}">
                {% endif %}
                <div class="author-details">
                    <a href="{% url 'users:author_profile' post.author.username %}" class="author-name">{{ post.author.username }}</a>
                    <span class="post-date">{{ post.time_update|date:"d.m.Y" }}</span>
                </div>
            </div>
            {% if user.is_authenticated and post.author != user %}
            <button id="subscribe-btn" 
                    class="btn btn-sm {% if is_subscribed %}btn-secondary{% else %}btn-primary{% endif %}"
                    data-author-id="{{ post.author.id }}">
                {% if is_subscribed %}–û—Ç–ø–∏—Å–∞—Ç—å—Å—è{% else %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% endif %}
            </button>
            {% endif %}
        </div>
        
        <p class="meta">
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <a href="{{ post.cat.get_absolute_url }}">{{ post.cat.name }}</a>
            &bull; {{ reading_time }} –º–∏–Ω —á—Ç–µ–Ω–∏—è
            &bull; {{ post.views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
        </p>

        {% if post.photo %}
        <p><img class="img-article" src="{{ post.photo.url }}"></p>
        {% endif %}

        {% autoescape off %}
        {{ post.content|safe }}
        {% endautoescape %}
    </div>

    {% with post.tags.all as tags %}
    {% if tags %}
    <p class="t-title">–¢–µ–≥–∏:</p>
    <ul class="tags-list">
        {% for t in tags %}
        <li><a class="tag" href="{{ t.get_absolute_url }}">{{ t.tag }}</a></li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    
    <hr>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="post-actions">
        <button id="like-btn"
                class="btn {% if post_is_liked %}btn-danger{% else %}btn-outline-danger{% endif %}"
                data-post-id="{{ object.id }}"
                data-liked="{{ post_is_liked|yesno:'true,false' }}">
            ‚ù§Ô∏è {{ number_of_likes }}
        </button>

        <button id="favorite-btn"
                class="btn {% if post_is_favorited %}btn-warning{% else %}btn-outline-warning{% endif %}"
                data-post-id="{{ object.id }}"
                data-favorited="{{ post_is_favorited|yesno:'true,false' }}">
            üîñ
        </button>

        <!-- –ö–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" -->
        <div class="share-buttons">
            <span class="share-label">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è:</span>
            <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text={{ post.title|urlencode }}" 
               target="_blank" class="btn btn-sm btn-outline-primary share-btn" title="Telegram">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                </svg>
            </a>
            <a href="https://vk.com/share.php?url={{ request.build_absolute_uri }}&title={{ post.title|urlencode }}" 
               target="_blank" class="btn btn-sm btn-outline-primary share-btn" title="VK">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.12-5.339-3.202-2.17-3.047-2.763-5.339-2.763-5.805 0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.864 2.508 2.305 4.708 2.897 4.708.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.744c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.253-1.406 2.15-3.574 2.15-3.574.119-.254.305-.491.745-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/>
                </svg>
            </a>
            <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title|urlencode }}" 
               target="_blank" class="btn btn-sm btn-outline-primary share-btn" title="Twitter">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
            </a>
            <button class="btn btn-sm btn-outline-secondary share-btn" onclick="copyLink()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
            </button>
        </div>
    </div>
</article>

<!-- –ü–æ—Ö–æ–∂–∏–µ —Å—Ç–∞—Ç—å–∏ -->
{% if similar_posts %}
<div class="post">
    <h3>–ü–æ—Ö–æ–∂–∏–µ —Å—Ç–∞—Ç—å–∏</h3>
    <div class="similar-posts">
        {% for p in similar_posts %}
        <div class="similar-post-card">
            {% if p.photo %}
            <img src="{{ p.photo.url }}" alt="{{ p.title }}" class="similar-post-img">
            {% endif %}
            <div class="similar-post-content">
                <a href="{{ p.get_absolute_url }}" class="similar-post-title">{{ p.title }}</a>
                <span class="similar-post-meta">{{ p.views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<section id="comments-section">
    <div class="post">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ {{ object.comments.count }}</h3>
        <form id="comment-form">
            {% csrf_token %}
            <input type="hidden" name="post_id" value="{{ object.id }}">
            <textarea name="content" id="comment-content" rows="3"
                    class="form-control mb-2"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </form>
    </div>
    <div id="comments-list">
        {% for comment in object.comments.all %}
        <div class="comment mb-3 p-2 border rounded" data-comment-id="{{ comment.id }}">
            <strong>{{ comment.author.username }}</strong>
            <small class="text-muted">{{ comment.created_at }}</small>
            {% if comment.author == user or user.is_staff %}
            <button class="delete-comment btn btn-sm btn-danger float-end"
                    data-comment-id="{{ comment.id }}">–£–¥–∞–ª–∏—Ç—å</button>
            {% endif %}
            <p>{{ comment.content }}</p>
        </div>
        {% endfor %}
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è
window.addEventListener('scroll', function() {
    const article = document.querySelector('article.post');
    const progressBar = document.getElementById('reading-progress');
    
    if (article && progressBar) {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrolled = window.scrollY;
        
        const progress = Math.min(100, Math.max(0, 
            ((scrolled - articleTop + windowHeight) / articleHeight) * 100
        ));
        
        progressBar.style.width = progress + '%';
    }
});

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    });
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    const subscribeBtn = document.getElementById('subscribe-btn');
    if (subscribeBtn) {
        subscribeBtn.addEventListener('click', function() {
            const authorId = this.getAttribute('data-author-id');
            const btn = this;
            
            fetch('{% url "subscribe_author" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `author_id=${authorId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.subscribed) {
                        btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                        btn.className = 'btn btn-sm btn-secondary';
                    } else {
                        btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                        btn.className = 'btn btn-sm btn-primary';
                    }
                }
            });
        });
    }

    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    const commentForm = document.getElementById('comment-form');
    const commentsList = document.getElementById('comments-list');

    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = document.getElementById('comment-content').value.trim();
        const postId = document.querySelector('input[name="post_id"]').value;

        if (!content) {
            alert('–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const submitBtn = commentForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        fetch('{% url "add_comment_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `post_id=${postId}&content=${encodeURIComponent(content)}`
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';

            if (data.success) {
                document.getElementById('comment-content').value = '';
                const newComment = createCommentElement(data.comment);
                commentsList.insertBefore(newComment, commentsList.firstChild);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
        });
    });

    function createCommentElement(commentData) {
        const div = document.createElement('div');
        div.className = 'comment mb-3 p-2 border rounded';
        div.setAttribute('data-comment-id', commentData.id);
        div.innerHTML = `
            <strong>${commentData.author}</strong>
            <small class="text-muted">${commentData.created_at}</small>
            <button class="delete-comment btn btn-sm btn-danger float-end"
                    data-comment-id="${commentData.id}">–£–¥–∞–ª–∏—Ç—å</button>
            <p>${commentData.content}</p>
        `;
        const deleteBtn = div.querySelector('.delete-comment');
        deleteBtn.addEventListener('click', handleDeleteComment);
        return div;
    }

    function handleDeleteComment(e) {
        const commentId = e.target.getAttribute('data-comment-id');
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

        fetch('{% url "delete_comment_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `comment_id=${commentId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-comment-id="${commentId}"]`).remove();
            }
        });
    }

    document.querySelectorAll('.delete-comment').forEach(btn => {
        btn.addEventListener('click', handleDeleteComment);
    });

    // –õ–∞–π–∫–∏ –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    const likeBtn = document.getElementById('like-btn');
    const favoriteBtn = document.getElementById('favorite-btn');

    likeBtn.addEventListener('click', function() {
        const postId = this.getAttribute('data-post-id');
        fetch('{% url "post_like_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `post_id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.innerHTML = `‚ù§Ô∏è ${data.likes_count}`;
                this.className = data.liked ? 'btn btn-danger' : 'btn btn-outline-danger';
            }
        });
    });

    favoriteBtn.addEventListener('click', function() {
        const postId = this.getAttribute('data-post-id');
        fetch('{% url "post_favorite_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `post_id=${postId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                this.className = data.favorited ? 'btn btn-warning' : 'btn btn-outline-warning';
            }
        });
    });
});
</script>
{% endblock %}
